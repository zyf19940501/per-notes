<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.73.0" />


<title>Data manipulation use dplyr package - 钟宇飞的博客</title>
<meta property="og:title" content="Data manipulation use dplyr package - 钟宇飞的博客">


  <link href='/favicon.ico' rel='icon' type='image/x-icon'/>



  








<link href='//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/logo.png"
         width="50"
         height="50"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="/categories/">Categories</a></li>
    
    <li><a href="/tags/">Tags</a></li>
    
    <li><a href="http://www.zhongyufei.com/Rbook/_book">R Study</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">23 min read</span>
    

    <h1 class="article-title">Data manipulation use dplyr package</h1>

    
    <span class="article-date">2020-09-28</span>
    

    <div class="article-content">
      
<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="前言" class="section level2">
<h2>前言</h2>
<p><code>dplyr</code>包是<code>tidyverse</code>系列中的核心包之一,<code>dplyr</code>包提供了一组一致的动词来解决最常见的数据处理难题：</p>
<ul>
<li><p><code>mutate()</code> 添加新变量,是现有变量得函数</p></li>
<li><p><code>select()</code> 筛选列,根据现有变量名称选这变量</p></li>
<li><p><code>filter()</code> 筛选行，根据条件筛选</p></li>
<li><p><code>summarise()</code> 按照一定条件汇总聚合</p></li>
<li><p><code>arrange()</code> 行排序</p></li>
</ul>
</div>
<div id="安装" class="section level2">
<h2>安装</h2>
<pre class="r"><code>## 最简单是的方式就是安装tidyverse
install.packages(&#39;tidyverse&#39;)

## 或者仅仅安装 tidyr:
install.packages(&#39;dplyr&#39;)

## 或者从github 安装开发版本
## install.packages(&quot;devtools&quot;)
devtools::install_github(&quot;tidyverse/dplyr&quot;)

# CTEST CODE</code></pre>
</div>
<div id="基础用法" class="section level2">
<h2>基础用法</h2>
<pre class="r"><code>library(dplyr)</code></pre>
<div id="filter" class="section level3">
<h3>filter</h3>
<ul>
<li>单条件筛选</li>
</ul>
<pre class="r"><code>starwars %&gt;% 
  filter(species == &quot;Droid&quot;)
## # A tibble: 6 x 14
##   name   height  mass hair_color skin_color  eye_color birth_year sex   gender  
##   &lt;chr&gt;   &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;   
## 1 C-3PO     167    75 &lt;NA&gt;       gold        yellow           112 none  masculi~
## 2 R2-D2      96    32 &lt;NA&gt;       white, blue red               33 none  masculi~
## 3 R5-D4      97    32 &lt;NA&gt;       white, red  red               NA none  masculi~
## 4 IG-88     200   140 none       metal       red               15 none  masculi~
## 5 R4-P17     96    NA none       silver, red red, blue         NA none  feminine
## 6 BB8        NA    NA none       none        black             NA none  masculi~
## # ... with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<ul>
<li>多条件</li>
</ul>
<pre class="r"><code>starwars %&gt;% 
  filter(species == &quot;Droid&quot;,skin_color == &quot;gold&quot;)
## # A tibble: 1 x 14
##   name  height  mass hair_color skin_color eye_color birth_year sex   gender   
##   &lt;chr&gt;  &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;    
## 1 C-3PO    167    75 &lt;NA&gt;       gold       yellow           112 none  masculine
## # ... with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;

# same above
# starwars %&gt;% 
#   filter(species == &quot;Droid&quot; &amp; skin_color == &quot;white&quot;)</code></pre>
<ul>
<li>多情况筛选</li>
</ul>
<pre class="r"><code>starwars %&gt;% 
  filter(species %in%  c(&quot;Droid&quot;,&#39;Clawdite&#39;))
## # A tibble: 7 x 14
##   name    height  mass hair_color skin_color   eye_color birth_year sex   gender
##   &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
## 1 C-3PO      167    75 &lt;NA&gt;       gold         yellow           112 none  mascu~
## 2 R2-D2       96    32 &lt;NA&gt;       white, blue  red               33 none  mascu~
## 3 R5-D4       97    32 &lt;NA&gt;       white, red   red               NA none  mascu~
## 4 IG-88      200   140 none       metal        red               15 none  mascu~
## 5 Zam We~    168    55 blonde     fair, green~ yellow            NA fema~ femin~
## 6 R4-P17      96    NA none       silver, red  red, blue         NA none  femin~
## 7 BB8         NA    NA none       none         black             NA none  mascu~
## # ... with 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;, films &lt;list&gt;,
## #   vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<ul>
<li>逻辑值筛选</li>
</ul>
<p>注意<code>|</code> ,<code>&amp;</code>,<code>!</code>等逻辑判断符号</p>
<pre class="r"><code>library(nycflights13)
filter(flights, !(arr_delay &gt; 120 | dep_delay &gt; 120))
## # A tibble: 316,050 x 19
##     year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
##  1  2013     1     1      517            515         2      830            819
##  2  2013     1     1      533            529         4      850            830
##  3  2013     1     1      542            540         2      923            850
##  4  2013     1     1      544            545        -1     1004           1022
##  5  2013     1     1      554            600        -6      812            837
##  6  2013     1     1      554            558        -4      740            728
##  7  2013     1     1      555            600        -5      913            854
##  8  2013     1     1      557            600        -3      709            723
##  9  2013     1     1      557            600        -3      838            846
## 10  2013     1     1      558            600        -2      753            745
## # ... with 316,040 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,
## #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,
## #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;
filter(flights, arr_delay &lt;= 120, dep_delay &lt;= 120)
## # A tibble: 316,050 x 19
##     year month   day dep_time sched_dep_time dep_delay arr_time sched_arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;          &lt;int&gt;
##  1  2013     1     1      517            515         2      830            819
##  2  2013     1     1      533            529         4      850            830
##  3  2013     1     1      542            540         2      923            850
##  4  2013     1     1      544            545        -1     1004           1022
##  5  2013     1     1      554            600        -6      812            837
##  6  2013     1     1      554            558        -4      740            728
##  7  2013     1     1      555            600        -5      913            854
##  8  2013     1     1      557            600        -3      709            723
##  9  2013     1     1      557            600        -3      838            846
## 10  2013     1     1      558            600        -2      753            745
## # ... with 316,040 more rows, and 11 more variables: arr_delay &lt;dbl&gt;,
## #   carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;, dest &lt;chr&gt;,
## #   air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</div>
<div id="select" class="section level3">
<h3>select</h3>
<p>当数据集较大列数较多时，我们可能并不需要那么多列，可以通过<code>select()</code>筛选：</p>
<ul>
<li>基础</li>
</ul>
<p>通过指定列名称筛选，顺便指定列之间顺序</p>
<pre class="r"><code>starwars %&gt;% 
  select(name,height,mass,hair_color,skin_color,eye_color)
## # A tibble: 87 x 6
##    name               height  mass hair_color    skin_color  eye_color
##    &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;    
##  1 Luke Skywalker        172    77 blond         fair        blue     
##  2 C-3PO                 167    75 &lt;NA&gt;          gold        yellow   
##  3 R2-D2                  96    32 &lt;NA&gt;          white, blue red      
##  4 Darth Vader           202   136 none          white       yellow   
##  5 Leia Organa           150    49 brown         light       brown    
##  6 Owen Lars             178   120 brown, grey   light       blue     
##  7 Beru Whitesun lars    165    75 brown         light       blue     
##  8 R5-D4                  97    32 &lt;NA&gt;          white, red  red      
##  9 Biggs Darklighter     183    84 black         light       brown    
## 10 Obi-Wan Kenobi        182    77 auburn, white fair        blue-gray
## # ... with 77 more rows</code></pre>
<ul>
<li>列索引</li>
</ul>
<p>通过列名或数字向量索引</p>
<pre class="r"><code>starwars %&gt;% 
  select(name : eye_color)
## # A tibble: 87 x 6
##    name               height  mass hair_color    skin_color  eye_color
##    &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;    
##  1 Luke Skywalker        172    77 blond         fair        blue     
##  2 C-3PO                 167    75 &lt;NA&gt;          gold        yellow   
##  3 R2-D2                  96    32 &lt;NA&gt;          white, blue red      
##  4 Darth Vader           202   136 none          white       yellow   
##  5 Leia Organa           150    49 brown         light       brown    
##  6 Owen Lars             178   120 brown, grey   light       blue     
##  7 Beru Whitesun lars    165    75 brown         light       blue     
##  8 R5-D4                  97    32 &lt;NA&gt;          white, red  red      
##  9 Biggs Darklighter     183    84 black         light       brown    
## 10 Obi-Wan Kenobi        182    77 auburn, white fair        blue-gray
## # ... with 77 more rows
#same above
starwars %&gt;% 
  select(1:6)
## # A tibble: 87 x 6
##    name               height  mass hair_color    skin_color  eye_color
##    &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;       &lt;chr&gt;    
##  1 Luke Skywalker        172    77 blond         fair        blue     
##  2 C-3PO                 167    75 &lt;NA&gt;          gold        yellow   
##  3 R2-D2                  96    32 &lt;NA&gt;          white, blue red      
##  4 Darth Vader           202   136 none          white       yellow   
##  5 Leia Organa           150    49 brown         light       brown    
##  6 Owen Lars             178   120 brown, grey   light       blue     
##  7 Beru Whitesun lars    165    75 brown         light       blue     
##  8 R5-D4                  97    32 &lt;NA&gt;          white, red  red      
##  9 Biggs Darklighter     183    84 black         light       brown    
## 10 Obi-Wan Kenobi        182    77 auburn, white fair        blue-gray
## # ... with 77 more rows
# starwars %&gt;% 
#   select(c(1,2,4,5,7))</code></pre>
</div>
<div id="rename" class="section level3">
<h3>rename</h3>
<p>列重命名使用<code>rename()</code></p>
<pre class="r"><code>starwars %&gt;% rename(home_world = homeworld)
## # A tibble: 87 x 14
##    name    height  mass hair_color  skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Luke S~    172    77 blond       fair       blue            19   male  mascu~
##  2 C-3PO      167    75 &lt;NA&gt;        gold       yellow         112   none  mascu~
##  3 R2-D2       96    32 &lt;NA&gt;        white, bl~ red             33   none  mascu~
##  4 Darth ~    202   136 none        white      yellow          41.9 male  mascu~
##  5 Leia O~    150    49 brown       light      brown           19   fema~ femin~
##  6 Owen L~    178   120 brown, grey light      blue            52   male  mascu~
##  7 Beru W~    165    75 brown       light      blue            47   fema~ femin~
##  8 R5-D4       97    32 &lt;NA&gt;        white, red red             NA   none  mascu~
##  9 Biggs ~    183    84 black       light      brown           24   male  mascu~
## 10 Obi-Wa~    182    77 auburn, wh~ fair       blue-gray       57   male  mascu~
## # ... with 77 more rows, and 5 more variables: home_world &lt;chr&gt;, species &lt;chr&gt;,
## #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
</div>
<div id="relocate" class="section level3">
<h3>relocate</h3>
<p>更改列顺序，与使用<code>select()</code>指定列顺序相似</p>
<pre class="r"><code># sex:homeworld列在height列前面
starwars %&gt;% relocate(sex:homeworld, .before = height)
## # A tibble: 87 x 14
##    name     sex    gender homeworld height  mass hair_color skin_color eye_color
##    &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt;      &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;    
##  1 Luke Sk~ male   mascu~ Tatooine     172    77 blond      fair       blue     
##  2 C-3PO    none   mascu~ Tatooine     167    75 &lt;NA&gt;       gold       yellow   
##  3 R2-D2    none   mascu~ Naboo         96    32 &lt;NA&gt;       white, bl~ red      
##  4 Darth V~ male   mascu~ Tatooine     202   136 none       white      yellow   
##  5 Leia Or~ female femin~ Alderaan     150    49 brown      light      brown    
##  6 Owen La~ male   mascu~ Tatooine     178   120 brown, gr~ light      blue     
##  7 Beru Wh~ female femin~ Tatooine     165    75 brown      light      blue     
##  8 R5-D4    none   mascu~ Tatooine      97    32 &lt;NA&gt;       white, red red      
##  9 Biggs D~ male   mascu~ Tatooine     183    84 black      light      brown    
## 10 Obi-Wan~ male   mascu~ Stewjon      182    77 auburn, w~ fair       blue-gray
## # ... with 77 more rows, and 5 more variables: birth_year &lt;dbl&gt;, species &lt;chr&gt;,
## #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
</div>
<div id="mutate" class="section level3">
<h3>mutate</h3>
<p><code>mutate()</code>在现有数据框基础上新增列</p>
<pre class="r"><code>starwars %&gt;% 
  mutate(bmi = mass / ((height / 100)  ^ 2)) %&gt;% 
  select(name:mass,bmi)
## # A tibble: 87 x 4
##    name               height  mass   bmi
##    &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 Luke Skywalker        172    77  26.0
##  2 C-3PO                 167    75  26.9
##  3 R2-D2                  96    32  34.7
##  4 Darth Vader           202   136  33.3
##  5 Leia Organa           150    49  21.8
##  6 Owen Lars             178   120  37.9
##  7 Beru Whitesun lars    165    75  27.5
##  8 R5-D4                  97    32  34.0
##  9 Biggs Darklighter     183    84  25.1
## 10 Obi-Wan Kenobi        182    77  23.2
## # ... with 77 more rows</code></pre>
<p>在新列基础上新增列</p>
<pre class="r"><code>starwars %&gt;% 
  mutate(bmi = mass / ((height / 100)  ^ 2),newbmi = bmi *2) %&gt;% 
  select(name:mass,bmi,newbmi)
## # A tibble: 87 x 5
##    name               height  mass   bmi newbmi
##    &lt;chr&gt;               &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1 Luke Skywalker        172    77  26.0   52.1
##  2 C-3PO                 167    75  26.9   53.8
##  3 R2-D2                  96    32  34.7   69.4
##  4 Darth Vader           202   136  33.3   66.7
##  5 Leia Organa           150    49  21.8   43.6
##  6 Owen Lars             178   120  37.9   75.7
##  7 Beru Whitesun lars    165    75  27.5   55.1
##  8 R5-D4                  97    32  34.0   68.0
##  9 Biggs Darklighter     183    84  25.1   50.2
## 10 Obi-Wan Kenobi        182    77  23.2   46.5
## # ... with 77 more rows</code></pre>
</div>
<div id="arrange" class="section level3">
<h3>arrange</h3>
<ul>
<li>单列排序默认升序，通过<code>desc()</code>降序排列</li>
</ul>
<pre class="r"><code>starwars %&gt;% 
  arrange(desc(mass))
## # A tibble: 87 x 14
##    name    height  mass hair_color  skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;    &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;       &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Jabba ~    175  1358 &lt;NA&gt;        green-tan~ orange         600   herm~ mascu~
##  2 Grievo~    216   159 none        brown, wh~ green, y~       NA   male  mascu~
##  3 IG-88      200   140 none        metal      red             15   none  mascu~
##  4 Darth ~    202   136 none        white      yellow          41.9 male  mascu~
##  5 Tarfful    234   136 brown       brown      blue            NA   male  mascu~
##  6 Owen L~    178   120 brown, grey light      blue            52   male  mascu~
##  7 Bossk      190   113 none        green      red             53   male  mascu~
##  8 Chewba~    228   112 brown       unknown    blue           200   male  mascu~
##  9 Jek To~    180   110 brown       fair       blue            NA   male  mascu~
## 10 Dexter~    198   102 none        brown      yellow          NA   male  mascu~
## # ... with 77 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,
## #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
<ul>
<li>多列排序</li>
</ul>
<pre class="r"><code>starwars %&gt;% 
  arrange(height,desc(mass))
## # A tibble: 87 x 14
##    name     height  mass hair_color skin_color eye_color birth_year sex   gender
##    &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;      &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; 
##  1 Yoda         66    17 white      green      brown            896 male  mascu~
##  2 Ratts T~     79    15 none       grey, blue unknown           NA male  mascu~
##  3 Wicket ~     88    20 brown      brown      brown              8 male  mascu~
##  4 Dud Bolt     94    45 none       blue, grey yellow            NA male  mascu~
##  5 R2-D2        96    32 &lt;NA&gt;       white, bl~ red               33 none  mascu~
##  6 R4-P17       96    NA none       silver, r~ red, blue         NA none  femin~
##  7 R5-D4        97    32 &lt;NA&gt;       white, red red               NA none  mascu~
##  8 Sebulba     112    40 none       grey, red  orange            NA male  mascu~
##  9 Gasgano     122    NA none       white, bl~ black             NA male  mascu~
## 10 Watto       137    NA black      blue, grey yellow            NA male  mascu~
## # ... with 77 more rows, and 5 more variables: homeworld &lt;chr&gt;, species &lt;chr&gt;,
## #   films &lt;list&gt;, vehicles &lt;list&gt;, starships &lt;list&gt;</code></pre>
</div>
<div id="summarise" class="section level3">
<h3>summarise</h3>
<p>按照分组聚合汇总</p>
<pre class="r"><code>starwars %&gt;%
  group_by(species) %&gt;%
  summarise(
    n = n(),
    mass = mean(mass, na.rm = TRUE)
  )
## # A tibble: 38 x 3
##    species       n  mass
##    &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt;
##  1 Aleena        1  15  
##  2 Besalisk      1 102  
##  3 Cerean        1  82  
##  4 Chagrian      1 NaN  
##  5 Clawdite      1  55  
##  6 Droid         6  69.8
##  7 Dug           1  40  
##  8 Ewok          1  20  
##  9 Geonosian     1  80  
## 10 Gungan        3  74  
## # ... with 28 more rows</code></pre>
</div>
</div>
<div id="表操作" class="section level2">
<h2>表操作</h2>
<div id="基础" class="section level3">
<h3>基础</h3>
<p><code>left_join()</code>,<code>full_join</code>,<code>inner_join()</code>等动词关联两个表。详情请查看：<code>vignette("two-table")</code></p>
<p><code>left_join()</code>实现类似Excel中<code>VLOOKUP</code>函数功能或数据库中<code>left join</code>功能。</p>
<ul>
<li>基础用法</li>
</ul>
<p><code>left_join()</code>,<code>right_join()</code>,<code>full_join()</code>,<code>inner_join</code>()，第一个以左表为主，第二个右表为主，第三个全连接，第四个内连接(只返回两表中都有的记录)，和数据库中连接方式一致。</p>
<pre class="r"><code>library(&quot;nycflights13&quot;)
# Drop unimportant variables so it&#39;s easier to understand the join results.
flights2 &lt;- flights %&gt;% select(year:day, hour, origin, dest, tailnum, carrier)

flights2 %&gt;% 
  left_join(airlines)
## # A tibble: 336,776 x 9
##     year month   day  hour origin dest  tailnum carrier name                    
##    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                   
##  1  2013     1     1     5 EWR    IAH   N14228  UA      United Air Lines Inc.   
##  2  2013     1     1     5 LGA    IAH   N24211  UA      United Air Lines Inc.   
##  3  2013     1     1     5 JFK    MIA   N619AA  AA      American Airlines Inc.  
##  4  2013     1     1     5 JFK    BQN   N804JB  B6      JetBlue Airways         
##  5  2013     1     1     6 LGA    ATL   N668DN  DL      Delta Air Lines Inc.    
##  6  2013     1     1     5 EWR    ORD   N39463  UA      United Air Lines Inc.   
##  7  2013     1     1     6 EWR    FLL   N516JB  B6      JetBlue Airways         
##  8  2013     1     1     6 LGA    IAD   N829AS  EV      ExpressJet Airlines Inc.
##  9  2013     1     1     6 JFK    MCO   N593JB  B6      JetBlue Airways         
## 10  2013     1     1     6 LGA    ORD   N3ALAA  AA      American Airlines Inc.  
## # ... with 336,766 more rows</code></pre>
<p>指定关联列，类似数据库中<code>on =  column</code></p>
<pre class="r"><code>flights2 %&gt;% left_join(planes, by = &quot;tailnum&quot;)
## # A tibble: 336,776 x 16
##    year.x month   day  hour origin dest  tailnum carrier year.y type            
##     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;           
##  1   2013     1     1     5 EWR    IAH   N14228  UA        1999 Fixed wing mult~
##  2   2013     1     1     5 LGA    IAH   N24211  UA        1998 Fixed wing mult~
##  3   2013     1     1     5 JFK    MIA   N619AA  AA        1990 Fixed wing mult~
##  4   2013     1     1     5 JFK    BQN   N804JB  B6        2012 Fixed wing mult~
##  5   2013     1     1     6 LGA    ATL   N668DN  DL        1991 Fixed wing mult~
##  6   2013     1     1     5 EWR    ORD   N39463  UA        2012 Fixed wing mult~
##  7   2013     1     1     6 EWR    FLL   N516JB  B6        2000 Fixed wing mult~
##  8   2013     1     1     6 LGA    IAD   N829AS  EV        1998 Fixed wing mult~
##  9   2013     1     1     6 JFK    MCO   N593JB  B6        2004 Fixed wing mult~
## 10   2013     1     1     6 LGA    ORD   N3ALAA  AA          NA &lt;NA&gt;            
## # ... with 336,766 more rows, and 6 more variables: manufacturer &lt;chr&gt;,
## #   model &lt;chr&gt;, engines &lt;int&gt;, seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;</code></pre>
<ul>
<li>不同名称列关联</li>
</ul>
<pre class="r"><code>#出发机场和目的机场信息
flights2 %&gt;% left_join(airports, by = c(&quot;dest&quot; = &quot;faa&quot;))
## # A tibble: 336,776 x 15
##     year month   day  hour origin dest  tailnum carrier name     lat   lon   alt
##    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1  2013     1     1     5 EWR    IAH   N14228  UA      Georg~  30.0 -95.3    97
##  2  2013     1     1     5 LGA    IAH   N24211  UA      Georg~  30.0 -95.3    97
##  3  2013     1     1     5 JFK    MIA   N619AA  AA      Miami~  25.8 -80.3     8
##  4  2013     1     1     5 JFK    BQN   N804JB  B6      &lt;NA&gt;    NA    NA      NA
##  5  2013     1     1     6 LGA    ATL   N668DN  DL      Harts~  33.6 -84.4  1026
##  6  2013     1     1     5 EWR    ORD   N39463  UA      Chica~  42.0 -87.9   668
##  7  2013     1     1     6 EWR    FLL   N516JB  B6      Fort ~  26.1 -80.2     9
##  8  2013     1     1     6 LGA    IAD   N829AS  EV      Washi~  38.9 -77.5   313
##  9  2013     1     1     6 JFK    MCO   N593JB  B6      Orlan~  28.4 -81.3    96
## 10  2013     1     1     6 LGA    ORD   N3ALAA  AA      Chica~  42.0 -87.9   668
## # ... with 336,766 more rows, and 3 more variables: tz &lt;dbl&gt;, dst &lt;chr&gt;,
## #   tzone &lt;chr&gt;
#flights2 %&gt;% left_join(airports, c(&quot;origin&quot; = &quot;faa&quot;))</code></pre>
<ul>
<li>筛选连接</li>
</ul>
<p><code>anti_join()</code> 删除所有左表中在右表中匹配到的行</p>
<p><code>semi_join()</code>保留所有左表在右表中匹配到的行</p>
<pre class="r"><code>df1 &lt;- tibble(a=letters[1:20],b=1:20)
df2 &lt;- tibble(a=letters,b=1:26)

df1 %&gt;% semi_join(df2)
## # A tibble: 20 x 2
##    a         b
##    &lt;chr&gt; &lt;int&gt;
##  1 a         1
##  2 b         2
##  3 c         3
##  4 d         4
##  5 e         5
##  6 f         6
##  7 g         7
##  8 h         8
##  9 i         9
## 10 j        10
## 11 k        11
## 12 l        12
## 13 m        13
## 14 n        14
## 15 o        15
## 16 p        16
## 17 q        17
## 18 r        18
## 19 s        19
## 20 t        20
df2 %&gt;% anti_join(df1)
## # A tibble: 6 x 2
##   a         b
##   &lt;chr&gt; &lt;int&gt;
## 1 u        21
## 2 v        22
## 3 w        23
## 4 x        24
## 5 y        25
## 6 z        26</code></pre>
<ul>
<li>集合操作</li>
</ul>
<ol style="list-style-type: decimal">
<li><p><code>intersect(x,y)</code>返回x,y交集</p></li>
<li><p><code>union(x,y)</code>返回x,y中唯一的值</p></li>
<li><p><code>setdiff(x,y)</code>返回存在x中但是不存在y中的记录</p></li>
</ol>
<pre class="r"><code>(df1 &lt;- tibble(x = 1:2, y = c(1L, 1L)))
## # A tibble: 2 x 2
##       x     y
##   &lt;int&gt; &lt;int&gt;
## 1     1     1
## 2     2     1
(df2 &lt;- tibble(x = 1:2, y = 1:2))
## # A tibble: 2 x 2
##       x     y
##   &lt;int&gt; &lt;int&gt;
## 1     1     1
## 2     2     2
intersect(df1, df2)
## # A tibble: 1 x 2
##       x     y
##   &lt;int&gt; &lt;int&gt;
## 1     1     1
union(df1, df2)
## # A tibble: 3 x 2
##       x     y
##   &lt;int&gt; &lt;int&gt;
## 1     1     1
## 2     2     1
## 3     2     2
setdiff(df1, df2)
## # A tibble: 1 x 2
##       x     y
##   &lt;int&gt; &lt;int&gt;
## 1     2     1
setdiff(df2, df1)
## # A tibble: 1 x 2
##       x     y
##   &lt;int&gt; &lt;int&gt;
## 1     2     2</code></pre>
</div>
<div id="多表操作" class="section level3">
<h3>多表操作</h3>
<p>多表操作请使用<code>purrr::reduce()</code></p>
</div>
</div>
<div id="列操作" class="section level2">
<h2>列操作</h2>
<p>在多列上执行相同的操作是经常有的操作，但是复制和粘贴麻烦还容易错：</p>
<pre class="r"><code>df %&gt;% 
  group_by(g1, g2) %&gt;% 
  summarise(a = mean(a), b = mean(b), c = mean(c), d = mean(d))</code></pre>
<p>通过<code>across()</code>函数可以更简洁地重写上面代码：</p>
<pre class="r"><code>df %&gt;% 
  group_by(g1, g2) %&gt;% 
  summarise(across(a:d, mean))</code></pre>
<div id="基本操作" class="section level3">
<h3>基本操作</h3>
<p>across() 有两个主要参数：</p>
<ul>
<li><p>第一个参数，.cols选择要操作的列。它使用<code>tidyr</code>的方式选择（例如select()），因此您可以按位置，名称和类型选择变量。</p></li>
<li><p>第二个参数，.fns是要应用于每一列的一个函数或函数列表。这也可以是purrr样式的公式（或公式列表），例如~ .x / 2。</p></li>
</ul>
<pre class="r"><code>starwars %&gt;% 
  summarise(across(where(is.character), ~ length(unique(.x))))
## # A tibble: 1 x 8
##    name hair_color skin_color eye_color   sex gender homeworld species
##   &lt;int&gt;      &lt;int&gt;      &lt;int&gt;     &lt;int&gt; &lt;int&gt;  &lt;int&gt;     &lt;int&gt;   &lt;int&gt;
## 1    87         13         31        15     5      3        49      38

# 列属性是字符的列求唯一值数
# starwars %&gt;% 
#   summarise(length(unique(name)))
# starwars %&gt;% 
#   summarise(length(unique(hair_color)))

starwars %&gt;% 
  group_by(species) %&gt;% 
  filter(n() &gt; 1) %&gt;% 
  summarise(across(c(sex, gender, homeworld), ~ length(unique(.x))))
## # A tibble: 9 x 4
##   species    sex gender homeworld
##   &lt;chr&gt;    &lt;int&gt;  &lt;int&gt;     &lt;int&gt;
## 1 Droid        1      2         3
## 2 Gungan       1      1         1
## 3 Human        2      2        16
## 4 Kaminoan     2      2         1
## 5 Mirialan     1      1         1
## 6 Twi&#39;lek      2      2         1
## 7 Wookiee      1      1         1
## 8 Zabrak       1      1         2
## 9 &lt;NA&gt;         1      1         3

starwars %&gt;% 
  group_by(homeworld) %&gt;% 
  filter(n() &gt; 1) %&gt;% 
  summarise(across(where(is.numeric), ~ mean(.x, na.rm = TRUE)))
## # A tibble: 10 x 4
##    homeworld height  mass birth_year
##    &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;
##  1 Alderaan    176.  64         43  
##  2 Corellia    175   78.5       25  
##  3 Coruscant   174.  50         91  
##  4 Kamino      208.  83.1       31.5
##  5 Kashyyyk    231  124        200  
##  6 Mirial      168   53.1       49  
##  7 Naboo       175.  64.2       55  
##  8 Ryloth      179   55         48  
##  9 Tatooine    170.  85.4       54.6
## 10 &lt;NA&gt;        139.  82        334.</code></pre>
<p><code>across()</code> 不会选择分组变量：</p>
<pre class="r"><code>df &lt;- data.frame(g = c(1, 1, 2), x = c(-1, 1, 3), y = c(-1, -4, -9))
df %&gt;% 
  group_by(g) %&gt;% 
  summarise(across(where(is.numeric), sum))
## # A tibble: 2 x 3
##       g     x     y
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1     0    -5
## 2     2     3    -9</code></pre>
</div>
<div id="多种函数功能" class="section level3">
<h3>多种函数功能</h3>
<p>通过在第二个参数提供函数或lambda函数的命名列表，可是使用多个函数转换每个变量：</p>
<pre class="r"><code>min_max &lt;- list(
  min = ~min(.x, na.rm = TRUE), 
  max = ~max(.x, na.rm = TRUE)
)
starwars %&gt;% summarise(across(where(is.numeric), min_max))
## # A tibble: 1 x 6
##   height_min height_max mass_min mass_max birth_year_min birth_year_max
##        &lt;int&gt;      &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;
## 1         66        264       15     1358              8            896</code></pre>
<p>通过<code>.names</code>参数控制名称：</p>
<p>NB:该参数的机制没有特别理解，需多练习体会。主要是用到匿名函数时</p>
<p>以下是官方图册中的案例，但是报错：</p>
<pre class="r"><code>starwars %&gt;% summarise(across(where(is.numeric), min_max, .names = &quot;{.fn}.{.col}&quot;))</code></pre>
<p>修改后：</p>
<pre class="r"><code>starwars %&gt;% summarise(across(where(is.numeric), min_max, .names = &quot;{fn}.{col}&quot;))
## # A tibble: 1 x 6
##   min.height max.height min.mass max.mass min.birth_year max.birth_year
##        &lt;int&gt;      &lt;int&gt;    &lt;dbl&gt;    &lt;dbl&gt;          &lt;dbl&gt;          &lt;dbl&gt;
## 1         66        264       15     1358              8            896</code></pre>
<p>区别主要是<code>.names</code>参数的使用方式问题，<code>.</code>加不加的问题。</p>
<pre class="r"><code>
starwars %&gt;% summarise(across(where(is.numeric), min_max, .names = &quot;{fn}——{col}&quot;))
</code></pre>
</div>
<div id="当前列" class="section level3">
<h3>当前列</h3>
<p>如果需要，可以通过调用访问内部的“当前”列的名称<code>cur_column()</code>。</p>
<pre class="r"><code>df &lt;- tibble(x = 1:3, y = 3:5, z = 5:7)
mult &lt;- list(x = 1, y = 10, z = 100)

df %&gt;% mutate(across(all_of(names(mult)), ~ .x * mult[[cur_column()]]))
## # A tibble: 3 x 3
##       x     y     z
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1     1    30   500
## 2     2    40   600
## 3     3    50   700</code></pre>
</div>
</div>
<div id="行操作" class="section level2">
<h2>行操作</h2>
<p>在操纵数据框中，<code>dplyr</code>等工具让我们对列操作相对简单，但是对行操作则困难些。</p>
<div id="构造数据集" class="section level3">
<h3>构造数据集</h3>
<pre class="r"><code>df &lt;- tibble(x = 1:2, y = 3:4, z = 5:6)
df %&gt;% rowwise()
## # A tibble: 2 x 3
## # Rowwise: 
##       x     y     z
##   &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     1     3     5
## 2     2     4     6</code></pre>
<p>像<code>group_by()</code>,<code>rowwise()</code>并没有做任何事情，它的作用是改变其他动词的工作方式：
比较以下代码中不的不同</p>
<pre class="r"><code>df %&gt;% mutate(m = mean(c(x, y, z)))
## # A tibble: 2 x 4
##       x     y     z     m
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
## 1     1     3     5   3.5
## 2     2     4     6   3.5
df %&gt;% rowwise() %&gt;% mutate(m = mean(c(x, y, z)))
## # A tibble: 2 x 4
## # Rowwise: 
##       x     y     z     m
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;
## 1     1     3     5     3
## 2     2     4     6     4</code></pre>
<p><code>data.table</code>中的操作:</p>
<pre class="r"><code>library(data.table)

dt &lt;- data.table(x = 1:2, y = 3:4, z = 5:6)
dt[,m:=mean(c(x,y,z))][]
dt[,m:=mean(c(x,y,z)),by=.(x)][]</code></pre>
<p>您可以选择在调用中提供“标识符”变量<code>rowwise()</code>。这些变量在您调用时被保留<code>summarise()</code>，因此它们的行为与传递给的分组变量有些相似<code>group_by()</code>：</p>
<pre class="r"><code>df &lt;- tibble(name = c(&quot;Mara&quot;, &quot;Hadley&quot;), x = 1:2, y = 3:4, z = 5:6)

df %&gt;% 
  rowwise() %&gt;% 
  summarise(m = mean(c(x, y, z)))
## # A tibble: 2 x 1
##       m
##   &lt;dbl&gt;
## 1     3
## 2     4

df %&gt;% 
  rowwise(name) %&gt;% 
  summarise(m = mean(c(x, y, z)))
## # A tibble: 2 x 2
## # Groups:   name [2]
##   name       m
##   &lt;chr&gt;  &lt;dbl&gt;
## 1 Mara       3
## 2 Hadley     4</code></pre>
</div>
<div id="行汇总统计" class="section level3">
<h3>行汇总统计</h3>
<p><code>dplyr::summarise()</code>使得汇总一列中各行的值非常容易。当与之结合使用时<code>rowwise()</code>，还可以轻松汇总一行中各列的值：</p>
<pre class="r"><code>df &lt;- tibble(id = 1:6, w = 10:15, x = 20:25, y = 30:35, z = 40:45)
rf &lt;- df %&gt;% rowwise(id)
rf %&gt;% mutate(total = sum(c(w, x, y, z)))
## # A tibble: 6 x 6
## # Rowwise:  id
##      id     w     x     y     z total
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     1    10    20    30    40   100
## 2     2    11    21    31    41   104
## 3     3    12    22    32    42   108
## 4     4    13    23    33    43   112
## 5     5    14    24    34    44   116
## 6     6    15    25    35    45   120
rf %&gt;% summarise(total = sum(c(w, x, y, z)))
## # A tibble: 6 x 2
## # Groups:   id [6]
##      id total
##   &lt;int&gt; &lt;int&gt;
## 1     1   100
## 2     2   104
## 3     3   108
## 4     4   112
## 5     5   116
## 6     6   120</code></pre>
<p>键入每个变量名称很繁琐，通过<code>c_across()</code>使更简单</p>
<pre class="r"><code>rf %&gt;% mutate(total = sum(c_across(w:z)))
## # A tibble: 6 x 6
## # Rowwise:  id
##      id     w     x     y     z total
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     1    10    20    30    40   100
## 2     2    11    21    31    41   104
## 3     3    12    22    32    42   108
## 4     4    13    23    33    43   112
## 5     5    14    24    34    44   116
## 6     6    15    25    35    45   120
rf %&gt;% mutate(total = sum(c_across(where(is.numeric))))
## # A tibble: 6 x 6
## # Rowwise:  id
##      id     w     x     y     z total
##   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
## 1     1    10    20    30    40   100
## 2     2    11    21    31    41   104
## 3     3    12    22    32    42   108
## 4     4    13    23    33    43   112
## 5     5    14    24    34    44   116
## 6     6    15    25    35    45   120

rf %&gt;% 
  mutate(total = sum(c_across(w:z))) %&gt;% 
  ungroup() %&gt;% 
  mutate(across(w:z, ~ . / total))
## # A tibble: 6 x 6
##      id     w     x     y     z total
##   &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
## 1     1 0.1   0.2   0.3   0.4     100
## 2     2 0.106 0.202 0.298 0.394   104
## 3     3 0.111 0.204 0.296 0.389   108
## 4     4 0.116 0.205 0.295 0.384   112
## 5     5 0.121 0.207 0.293 0.379   116
## 6     6 0.125 0.208 0.292 0.375   120</code></pre>
</div>
</div>
<div id="分组操作" class="section level2">
<h2>分组操作</h2>
<p>详情: <a href="https://cloud.r-project.org/web/packages/dplyr/vignettes/grouping.html" class="uri">https://cloud.r-project.org/web/packages/dplyr/vignettes/grouping.html</a></p>
<p><code>group_by()</code>最重要的分组动词,需要一个数据框和一个或多个变量进行分组：</p>
<div id="添加分组" class="section level3">
<h3>添加分组</h3>
<pre class="r"><code>by_species &lt;- starwars %&gt;% group_by(species)
by_sex_gender &lt;- starwars %&gt;% group_by(sex, gender)</code></pre>
<p>除了按照现有变量分组外，还可以按照函数处理后的变量分组，等效在<code>mutate()</code>之后执行<code>group_by</code>:</p>
<pre class="r"><code>bmi_breaks &lt;- c(0, 18.5, 25, 30, Inf)
starwars %&gt;%
  group_by(bmi_cat = cut(mass/(height/100)^2, breaks=bmi_breaks)) %&gt;%
  tally()
## # A tibble: 5 x 2
##   bmi_cat       n
##   &lt;fct&gt;     &lt;int&gt;
## 1 (0,18.5]     10
## 2 (18.5,25]    24
## 3 (25,30]      13
## 4 (30,Inf]     12
## 5 &lt;NA&gt;         28</code></pre>
</div>
<div id="删除分组变量" class="section level3">
<h3>删除分组变量</h3>
<p>要删除所有分组变量，使用<code>ungroup()</code>:</p>
<pre class="r"><code>by_species %&gt;%
  ungroup() %&gt;%
  tally()
## # A tibble: 1 x 1
##       n
##   &lt;int&gt;
## 1    87</code></pre>
</div>
<div id="动词" class="section level3">
<h3>动词</h3>
<p><code>summarise()</code> 计算每个组的汇总，表示从<code>group_keys</code>开始右侧添加汇总变量</p>
<pre class="r"><code>by_species %&gt;%
  summarise(
    n = n(),
    height = mean(height, na.rm = TRUE)
  )
## # A tibble: 38 x 3
##    species       n height
##    &lt;chr&gt;     &lt;int&gt;  &lt;dbl&gt;
##  1 Aleena        1    79 
##  2 Besalisk      1   198 
##  3 Cerean        1   198 
##  4 Chagrian      1   196 
##  5 Clawdite      1   168 
##  6 Droid         6   131.
##  7 Dug           1   112 
##  8 Ewok          1    88 
##  9 Geonosian     1   183 
## 10 Gungan        3   209.
## # ... with 28 more rows</code></pre>
<p>该<code>.groups=</code>参数控制输出的分组结构。删除右侧分组变量的历史行为对应于<code>.groups =</code> “drop_last”没有消息或.groups = NULL有消息（默认值）。</p>
<p>从1.0.0版开始，分组信息可以保留<code>(.groups = "keep")</code>或删除 <code>(.groups = 'drop)</code></p>
<pre class="r"><code>a &lt;- by_species %&gt;%
  summarise(
    n = n(),
    height = mean(height, na.rm = TRUE),.groups=&#39;drop&#39;) %&gt;% 
  group_vars()

b &lt;- by_species %&gt;%
  summarise(
    n = n(),
    height = mean(height, na.rm = TRUE),.groups=&#39;keep&#39;) %&gt;% 
  group_vars()

object.size(a)
## 48 bytes
object.size(b)
## 112 bytes</code></pre>
<p>在实际使用中，当数据较大时需要删掉分组信息。以上可以看到保留分组信息的比没保留的大了两倍多。</p>
</div>
</div>
<div id="用dplyr编程" class="section level2">
<h2>用<code>dplyr</code>编程</h2>
<p>Programming with dplyr:</p>
<p><a href="https://cloud.r-project.org/web/packages/dplyr/vignettes/programming.html" class="uri">https://cloud.r-project.org/web/packages/dplyr/vignettes/programming.html</a></p>
<p>本节概念性东西较多且复杂不易理解，先尝试会使用，概念再慢慢消化理解。</p>
<p>虽然复杂但是比较实用，尤其是当我们需要定义一些通用功能函数时</p>
<p>以下是对原文引用</p>
<p>两种情况：</p>
<ul>
<li>When you have the data-variable in a function argument (i.e. an env-variable that holds a promise2), you need to ** embrace ** the argument by surrounding it in doubled braces, like <code>filter(df, {{ var }})</code>.</li>
</ul>
<p>The following function uses embracing to create a wrapper around <code>summarise()</code> that computes the minimum and maximum values of a variable, as well as the number of observations that were summarised:</p>
<pre class="r"><code>var_summary &lt;- function(data, var) {
  data %&gt;%
    summarise(n = n(), min = min({{ var }}), max = max({{ var }}))
}
mtcars %&gt;% 
  group_by(cyl) %&gt;% 
  var_summary(mpg)</code></pre>
<ul>
<li>When you have an env-variable that is a character vector, you need to index into the .data pronoun with [[, like summarise(df, mean = mean(.data[[var]])).</li>
</ul>
<p>The following example uses .data to count the number of unique values in each variable of mtcars:</p>
<pre class="r"><code>for (var in names(mtcars)) {
  mtcars %&gt;% count(.data[[var]]) %&gt;% print()
}</code></pre>
<p>Note that .data is not a data frame; it’s a special construct, a pronoun, that allows you to access the current variables either directly, with <code>.data$x</code> or indirectly with <code>.data[[var]]</code>. Don’t expect other functions to work with it.</p>
<div id="案例" class="section level3">
<h3>案例</h3>
<p>当我们不知道接下来会用哪个变量汇总时：</p>
<pre class="r"><code>my_summarise &lt;- function(data, group_var) {
  data %&gt;%
    group_by({{ group_var }}) %&gt;%
    summarise(mean = mean(mass))
}</code></pre>
<p>如果在多个位置使用：</p>
<pre class="r"><code>my_summarise2 &lt;- function(data, expr) {
  data %&gt;% summarise(
    mean = mean({{ expr }}),
    sum = sum({{ expr }}),
    n = n()
  )
}</code></pre>
<p>当多个表达式时：</p>
<pre class="r"><code>my_summarise3 &lt;- function(data, mean_var, sd_var) {
  data %&gt;% 
    summarise(mean = mean({{ mean_var }}), sd = mean({{ sd_var }}))
}</code></pre>
<p>如果要输出变量名时：</p>
<pre class="r"><code>my_summarise4 &lt;- function(data, expr) {
  data %&gt;% summarise(
    &quot;mean_{{expr}}&quot; := mean({{ expr }}),
    &quot;sum_{{expr}}&quot; := sum({{ expr }}),
    &quot;n_{{expr}}&quot; := n()
  )
}
my_summarise5 &lt;- function(data, mean_var, sd_var) {
  data %&gt;% 
    summarise(
      &quot;mean_{{mean_var}}&quot; := mean({{ mean_var }}), 
      &quot;sd_{{sd_var}}&quot; := mean({{ sd_var }})
    )
}</code></pre>
<p>任意个表达式：</p>
<p>这种使用场景更多</p>
<pre class="r"><code>my_summarise &lt;- function(.data, ...) {
  .data %&gt;%
    group_by(...) %&gt;%
    summarise(mass = mean(mass, na.rm = TRUE), height = mean(height, na.rm = TRUE))
}
starwars %&gt;% my_summarise(homeworld)
## # A tibble: 49 x 3
##    homeworld       mass height
##    &lt;chr&gt;          &lt;dbl&gt;  &lt;dbl&gt;
##  1 Alderaan        64     176.
##  2 Aleen Minor     15      79 
##  3 Bespin          79     175 
##  4 Bestine IV     110     180 
##  5 Cato Neimoidia  90     191 
##  6 Cerea           82     198 
##  7 Champala       NaN     196 
##  8 Chandrila      NaN     150 
##  9 Concord Dawn    79     183 
## 10 Corellia        78.5   175 
## # ... with 39 more rows
starwars %&gt;% my_summarise(sex, gender)
## # A tibble: 6 x 4
## # Groups:   sex [5]
##   sex            gender      mass height
##   &lt;chr&gt;          &lt;chr&gt;      &lt;dbl&gt;  &lt;dbl&gt;
## 1 female         feminine    54.7   169.
## 2 hermaphroditic masculine 1358     175 
## 3 male           masculine   81.0   179.
## 4 none           feminine   NaN      96 
## 5 none           masculine   69.8   140 
## 6 &lt;NA&gt;           &lt;NA&gt;        48     181.</code></pre>
</div>
</div>

    </div>
  </article>

  


</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备44030602004537号</a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>



<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/r.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>

